'''
Created on Sep 26, 2014

@author: Matthew
'''
from django.views.generic import TemplateView
from twilio.rest import TwilioRestClient 
from django.http import HttpResponseRedirect
from django.http import HttpResponse
from django.shortcuts import render
from django.shortcuts import render_to_response
import urllib2
import urllib
from django.http import HttpResponse

from django.forms.formsets import formset_factory
import models
import django_twilio

def test_page(request):
    user = models.User(first_name="matt",last_name="maclean")
    user.save()
    return render(request, 'test.html')

def admin_home_page(request):
    pairs = []
    for pair in models.Pair.objects.all():
        mentor = models.User.objects.get(id=pair.mentor_id)
        mentor_name = mentor.first_name + " " + mentor.last_name
        mentee = models.User.objects.get(id=pair.mentee_id)
        mentee_name = mentee.first_name + " " + mentor.last_name
        dict = {"id": pair.id,
                "mentor_name": mentor_name,
                "mentee_name": mentee_name,
                "freq": 0}
        pairs.append(dict)
    return render(request, 'Admin_home_page.html', {"pairs": pairs})

def admin_history(request):
    return render(request, 'Admin_history.html')
def admin_mentor_mentee(request):
    return render(request, 'Admin_mentor_mentee.html')
def login_page(request):
    return render(request, 'login.html')

def login_request(request):
    email = request.POST.get('email')
    print email
    password = request.POST.get('password')
    print password
    return render_to_response("Invalid")

def view_pair_profile(request):
    pair_id = long(request.GET.get("pair_id"))
    return render(request, 'profile.html', {'pair_id': pair_id})
    
def view_history(request):
    print "in view history"
    pair_id = long(request.GET.get('pair_id'))
    print "here"
    pair = models.Pair.objects.get(id=pair_id)
    messages = models.Message.objects.filter(pair_id=pair_id)
    mentor = models.User.objects.get(id=pair.mentor_id)
    mentee = models.User.objects.get(id=pair.mentee_id)
    print"below"
    print len(messages)
    return render(request, 'Admin_history.html', {"messages": messages,
                                                  "mentor_id": pair.mentor_id,
                                                  "mentee_id": pair.mentee_id,
                                                  "mentor_name": mentor.first_name,
                                                  "mentee_name": mentee.first_name})

def route_message(request):
    print "in route message"
    phone_number_incoming = request.GET.get('From')
    text = request.GET.get('Body')
    print phone_number_incoming
    print "sending"
    post_data = [('From','+17328100314'),('To',phone_number_incoming), ('Body',text)]
    result = urllib2.urlopen('/2010-04-01/Accounts/{ACa3784f71861749cee6445c4d2f182f27}/SMS/Messages', urllib.urlencode(post_data))
    content = result.read()
    TWILIO_ACCOUNT_SID = 'ACa3784f71861749cee6445c4d2f182f27'
    TWILIO_AUTH_TOKEN = '7a474c787f36db39c3c08edce40598a2'
    #django_twilio.views.message(request, text, phone_number_incoming, '+17328100314', None, None, None, '/message/completed/')


    

    


def initialize_data(request):
    # Create mentor and mentee
    moses = models.User(first_name="Moses", last_name="Soh", email="moses.soh@gmail.com", phone_number="+12676487834", type=0)
    moses.save()
    matt = models.User(first_name="Matt", last_name="MacLean", email="matthewtmaclean@gmail.com", phone_number="+19086921924", type=1)
    matt.save()
    bryan = models.User(first_name="Bryan", last_name="Cam", email="bryanrcam@gmail.com", phone_number="+17862395770", type=2)
    bryan.save()
    # Create pairing
    pair = models.Pair(mentor=matt, mentee=moses, admin=bryan)
    pair.save()
    # Add messages
    message = models.Message(user_from=moses, user_to=matt, pair=pair,text="Hello Mentor")
    message.save()
    message = models.Message(user_from=matt, user_to=moses, pair=pair,text="Hello Mentee")
    message.save() 


